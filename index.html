<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üçÑ Logik</title>
<script>try{var t=localStorage.getItem('logik_theme');if(!t&&window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches)t='dark';if(t==='dark')document.documentElement.setAttribute('data-theme','dark')}catch(e){}</script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{--bg:#fdf6ec;--card:#fff8f0;--card2:#fff0e0;--text:#3b2a1a;--text2:#6b5a45;--border:#e8d8c4;--btn:#c97b4a;--btnH:#b86d3e;--acc:#c97b4a;--sh:0 4px 18px rgba(0,0,0,.08);--cell:#fff3e8;--cellB:#dcc8ad;--hdr:linear-gradient(135deg,#f9c074,#f0a05a);--inp:#fff;--ovl:rgba(59,42,26,.55);--mod:#fff8f0;--sel:0 0 0 3px #c97b4a;--win:#4caf50;--lose:#e57373}
:root[data-theme=dark],body[data-theme=dark]{--bg:#1a1210;--card:#2a2220;--card2:#322a22;--text:#f0e6d8;--text2:#b8a890;--border:#3f3530;--btn:#c97b4a;--btnH:#b86d3e;--acc:#e8a87c;--sh:0 4px 18px rgba(0,0,0,.35);--cell:#322a22;--cellB:#4a403a;--hdr:linear-gradient(135deg,#3a2a1a,#2a1e10);--inp:#2a2220;--ovl:rgba(0,0,0,.6);--mod:#2a2220;--sel:0 0 0 3px #e8a87c;--win:#66bb6a;--lose:#ef5350}
body{font-family:'Segoe UI',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;transition:background .3s,color .3s}
.hdr{background:var(--hdr);padding:16px 20px 12px;text-align:center;position:relative;box-shadow:var(--sh)}
.hdr h1{font-size:1.6em;color:#fff;text-shadow:0 1px 3px rgba(0,0,0,.2)}
.hdr .sub{font-size:.78em;color:rgba(255,255,255,.8)}
.tgl{position:absolute;top:14px;right:18px;background:none;border:none;font-size:1.4em;cursor:pointer}
.tabs{display:flex;justify-content:center;gap:6px;padding:12px 10px 4px}
.tab{padding:7px 18px;border:none;border-radius:20px;cursor:pointer;font-size:.85em;font-weight:600;background:var(--border);color:var(--text2);transition:all .2s}
.tab.act{background:var(--btn);color:#fff}
.pg{display:none;max-width:480px;margin:0 auto;padding:10px 12px 24px}
.pg.act{display:block}
.card{background:var(--card);border-radius:14px;padding:20px 18px;box-shadow:var(--sh);border:1px solid var(--border)}
.card h2{font-size:1em;margin-bottom:14px;color:var(--acc);text-align:center}
.sr{display:flex;flex-direction:column;gap:5px;margin-bottom:14px}
.sr label{font-size:.76em;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:.5px}
.sr input{padding:8px 10px;border-radius:8px;border:1px solid var(--cellB);background:var(--inp);color:var(--text);font-size:.9em;outline:none}
.sr input:focus{border-color:var(--acc)}
.diffDesc{font-size:.72em;color:var(--text2);text-align:center;margin-top:6px}
.btnRow{display:flex;gap:6px}
.btnRow button{flex:1;padding:9px 4px;border-radius:8px;border:2px solid var(--border);background:var(--cell);color:var(--text);cursor:pointer;font-size:.82em;font-weight:600;text-align:center;transition:all .2s}
.btnRow button.act{border-color:var(--acc);background:var(--acc);color:#fff}
:root[data-theme=dark] .btnRow button.act{color:#1a1210}
.startBtn{width:100%;padding:11px;border:none;border-radius:10px;background:var(--btn);color:#fff;font-size:.95em;font-weight:700;cursor:pointer;margin-top:6px;transition:background .2s}
.startBtn:hover{background:var(--btnH)}
.startBtn:disabled{background:var(--border);color:var(--text2);cursor:not-allowed}
.ghdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.ginfo{font-size:.8em;color:var(--text2)}
.ginfo span{font-weight:700;color:var(--acc)}
.timer{font-size:.8em;color:var(--text2);text-align:center;margin-bottom:6px}
.timer span{font-weight:700;color:var(--acc)}
.timer.warn span{color:var(--lose)}
.bbtn{background:none;border:none;color:var(--text2);cursor:pointer;font-size:.8em;text-decoration:underline}
.board{display:flex;flex-direction:column;gap:5px;margin-bottom:10px}
.grow{display:flex;align-items:center;gap:5px;background:var(--cell);border-radius:8px;padding:5px 6px;border:1px solid var(--cellB)}
.grow.cur{border-color:var(--acc);background:var(--card)}
.grow.empty{opacity:.35}
.grow.done{animation:rIn .25s ease}
@keyframes rIn{from{opacity:0;transform:translateY(-5px)}to{opacity:1;transform:translateY(0)}}
.rn{font-size:.7em;color:var(--text2);width:16px;text-align:center;font-weight:700}
.peg{width:34px;height:34px;border-radius:50%;border:2px solid rgba(0,0,0,.15);box-shadow:0 2px 5px rgba(0,0,0,.2);transition:transform .15s;cursor:pointer}
.peg:hover{transform:scale(1.1)}
.peg.ep{background:var(--cell);border:2px dashed var(--cellB);box-shadow:none;cursor:pointer}
.peg.ep:hover{transform:scale(1.05)}
.peg.slotSel{box-shadow:var(--sel);transform:scale(1.08);border-color:var(--acc)}
.fb{display:flex;flex-wrap:wrap;gap:2px;width:44px;justify-content:center;margin-left:auto}
.fbp{width:11px;height:11px;border-radius:50%}
.fbb{background:#2d2d2d;box-shadow:0 1px 2px rgba(0,0,0,.3);border:1px solid transparent}
:root[data-theme=dark] .fbb{border-color:#888}
.fbw{background:#fff;border:2px solid #999}
.palSec{background:var(--card);border-radius:12px;padding:12px 14px;border:1px solid var(--border);box-shadow:var(--sh);margin-bottom:10px}
.palLbl{font-size:.72em;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:7px;font-weight:600}
.pal{display:flex;gap:7px;flex-wrap:wrap;justify-content:center}
.pal .peg{width:40px;height:40px}
.pal .peg.sel{box-shadow:var(--sel);transform:scale(1.05)}
.abts{display:flex;gap:7px}
.abts button{flex:1;padding:9px;border:none;border-radius:9px;font-size:.85em;font-weight:700;cursor:pointer;transition:background .2s}
.bSub{background:var(--btn);color:#fff}
.bSub:hover{background:var(--btnH)}
.bSub:disabled{background:var(--border);color:var(--text2);cursor:not-allowed}
.bClr{background:var(--card2);color:var(--text2)}
.colorPop{display:none;position:fixed;z-index:150;background:var(--mod);border-radius:14px;padding:12px;box-shadow:0 6px 30px rgba(0,0,0,.3);border:1px solid var(--border)}
.colorPop.show{display:block;animation:mIn .15s ease}
.colorPop .cpTitle{font-size:.75em;color:var(--text2);text-align:center;margin-bottom:8px;font-weight:600}
.colorPop .cpColors{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-bottom:10px}
.colorPop .peg{width:44px;height:44px}
.colorPop .cpSub{width:100%;padding:9px;border:none;border-radius:8px;font-size:.85em;font-weight:700;cursor:pointer;background:var(--btn);color:#fff}
.colorPop .cpSub:disabled{background:var(--border);color:var(--text2);cursor:not-allowed}
.secRow{display:flex;align-items:center;gap:5px;background:var(--card2);border-radius:8px;padding:5px 6px;border:1px dashed var(--border);margin-bottom:8px}
.secLbl{font-size:.7em;color:var(--text2);margin-left:auto;font-weight:600;text-transform:uppercase}
.ovl{display:none;position:fixed;inset:0;background:var(--ovl);z-index:100;justify-content:center;align-items:center}
.ovl.show{display:flex}
.modal{background:var(--mod);border-radius:18px;padding:28px 24px;text-align:center;box-shadow:0 8px 40px rgba(0,0,0,.3);max-width:320px;width:90%;animation:mIn .25s ease;position:relative}
.mClose{position:absolute;top:10px;right:14px;background:none;border:none;font-size:1.3em;color:var(--text2);cursor:pointer;padding:4px 8px;border-radius:6px;transition:background .2s}
.mClose:hover{background:var(--card2)}
.modal .btnRow button.sel{box-shadow:var(--sel)}
@keyframes mIn{from{opacity:0;transform:scale(.9)}to{opacity:1;transform:scale(1)}}
.modal h2{font-size:1.5em;margin-bottom:4px}
.modal h2.win{color:var(--win)}
.modal h2.lose{color:var(--lose)}
.modal p{color:var(--text2);font-size:.84em;margin-bottom:16px}
.modal .btnRow{flex-direction:column;gap:7px}
.modal .btnRow button{padding:9px;border-radius:9px;border:none;font-size:.88em;font-weight:700;cursor:pointer}
.modal .btnRow .pri{background:var(--btn);color:#fff}
.modal .btnRow .pri:hover{background:var(--btnH)}
.modal .btnRow .sec2{background:var(--card2);color:var(--text2)}
.sGrid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px}
.sBox{background:var(--cell);border-radius:10px;padding:10px 6px;text-align:center;border:1px solid var(--border)}
.sBox .val{font-size:1.5em;font-weight:800;color:var(--acc)}
.sBox .lbl{font-size:.68em;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-top:2px}
.sList{max-height:180px;overflow-y:auto}
.sItem{display:flex;justify-content:space-between;align-items:center;padding:7px 8px;font-size:.78em;border-bottom:1px solid var(--border)}
.sItem:last-child{border-bottom:none}
.sItem .sn{font-weight:600}
.sItem .sres{font-weight:700}
.sItem .sres.win{color:var(--win)}
.sItem .sres.lose{color:var(--lose)}
.sItem .sa{color:var(--text2)}
.clrBtn{background:none;border:1px solid var(--border);color:var(--text2);padding:5px 12px;border-radius:7px;cursor:pointer;font-size:.72em;margin-top:8px;display:block;margin-left:auto;margin-right:auto}
.clrBtn:hover{border-color:var(--lose);color:var(--lose)}
.sTabs{display:flex;gap:4px;margin-bottom:12px}
.sTab{flex:1;padding:6px 4px;border:none;border-radius:8px;cursor:pointer;font-size:.75em;font-weight:600;background:var(--border);color:var(--text2);transition:all .2s}
.sTab.act{background:var(--btn);color:#fff}
.pSel{width:100%;padding:8px 10px;border-radius:8px;border:1px solid var(--cellB);background:var(--inp);color:var(--text);font-size:.85em;margin-bottom:10px}
.cmpBox{background:var(--cell);border-radius:10px;padding:12px;border:1px solid var(--border);margin-bottom:10px}
.cmpTitle{font-size:.8em;font-weight:700;color:var(--acc);text-align:center;margin-bottom:8px}
.cmpRow{display:flex;justify-content:space-between;align-items:center;padding:4px 0;font-size:.78em}
.cmpRow .cmpN{font-weight:600;flex:1}
.cmpRow .cmpV{font-weight:700;color:var(--acc);width:50px;text-align:center}
.cmpRow .cmpBar{flex:2;height:8px;background:var(--border);border-radius:4px;margin:0 8px;overflow:hidden;display:flex}
.cmpBar .cmpL{background:var(--btn);height:100%}
.cmpBar .cmpR{background:var(--win);height:100%}
.pCard{background:var(--cell);border-radius:10px;padding:10px;border:1px solid var(--border);margin-bottom:8px}
.pCard .pName{font-weight:700;color:var(--acc);font-size:.9em;margin-bottom:6px}
.pCard .pStats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px;font-size:.72em;color:var(--text2)}
.pCard .pStats span{text-align:center}
.pCard .pStats .pVal{font-weight:700;color:var(--text)}
.noH{color:var(--text2);font-size:.8em;text-align:center;padding:12px 0}
.ftr{text-align:center;padding:12px;font-size:.75em;color:var(--text2)}
</style>
</head>
<body data-theme="bright">
<div class="hdr">
  <button class="tgl" id="tglBtn" onclick="toggleTheme()">üåô</button>
  <h1>üçÑ Logik</h1>
  <div class="sub">Mastermind ‚Äì logick√© skl√°d√°n√≠</div>
</div>
<div class="tabs">
  <button class="tab act" id="tab0" onclick="showTab('setup',0)">Nastaven√≠</button>
  <button class="tab" id="tab1" onclick="showTab('game',1)">Hra</button>
  <button class="tab" id="tab2" onclick="showTab('stats',2)">Statistiky</button>
  <button class="tab" id="tab3" onclick="showTab('online',3)">Online</button>
</div>
<div class="pg act" id="pg-setup">
  <div class="card">
    <h2>Zah√°jit novou hru</h2>
    <div class="sr"><label>Hern√≠ m√≥d</label>
      <div class="btnRow"><button class="act" id="m1p" onclick="setMode('1p')">ü§ñ 1 hr√°ƒç</button><button id="m2p" onclick="setMode('2p')">üë• 2 hr√°ƒçi</button></div>
    </div>
    <div class="sr" id="n1r"><label>Tv√© jm√©no</label><input type="text" id="n1" placeholder="Hr√°ƒç 1" maxlength="16" onblur="saveSettings()"></div>
    <div class="sr" id="n2r" style="display:none"><label>Jm√©no 2. hr√°ƒçe</label><input type="text" id="n2" placeholder="Hr√°ƒç 2" maxlength="16" onblur="saveSettings()"></div>
    <div class="sr" id="whoEntersR" style="display:none"><label>Kdo zad√°v√° tajn√Ω k√≥d</label>
      <div class="btnRow"><button class="act" id="we1" onclick="setWhoEnters(1)">Hr√°ƒç 1</button><button id="we2" onclick="setWhoEnters(2)">Hr√°ƒç 2</button></div>
    </div>
    <div class="sr" id="diffR"><label>Obt√≠≈ænost</label>
      <div class="btnRow"><button class="act" id="dE" onclick="setDiff('easy')" title="6 barev, bez opakov√°n√≠, 12 pokus≈Ø">Lehk√°</button><button id="dM" onclick="setDiff('medium')" title="6 barev, s opakov√°n√≠m, 10 pokus≈Ø">St≈ôedn√≠</button><button id="dH" onclick="setDiff('hard')" title="8 barev, s opakov√°n√≠m, 8 pokus≈Ø">Tƒõ≈æk√°</button></div>
      <div class="diffDesc" id="diffDesc"></div>
    </div>
    <div class="sr"><label>ƒåasov√Ω limit</label>
      <div class="btnRow"><button class="act" id="tlOff" onclick="setTimeLimit(0)">Vypnuto</button><button id="tl3" onclick="setTimeLimit(3)">3 min</button><button id="tl5" onclick="setTimeLimit(5)">5 min</button><button id="tl10" onclick="setTimeLimit(10)">10 min</button></div>
    </div>
    <button class="startBtn" onclick="initAudio();startGame()">Zaƒç√≠t hru ‚ñ∂</button>
  </div>
</div>
<div class="pg" id="pg-online">
  <div class="card">
    <h2>üåê Hra p≈ôes internet</h2>
    <div class="sr"><label>Vytvo≈ôit novou hru</label>
      <p class="ginfo" style="margin-bottom:6px">Ty zad√°≈° tajn√Ω k√≥d, druh√Ω hr√°ƒç se p≈ôipoj√≠ a bude h√°dat.</p>
      <button class="startBtn" id="btnCreateOnline" onclick="createOnlineGame()">Vytvo≈ôit hru</button>
    </div>
    <div class="sr" style="margin-top:16px"><label>P≈ôipojit se k h≈ôe</label>
      <input type="text" id="onlineCode" placeholder="6m√≠stn√Ω k√≥d (nap≈ô. AB12CD)" maxlength="6" style="text-transform:uppercase">
      <button class="startBtn" id="btnJoinOnline" onclick="joinOnlineGame()" style="margin-top:8px">P≈ôipojit se</button>
    </div>
    <div id="onlineLobby" class="sr" style="display:none;margin-top:12px;padding:10px;background:var(--cell);border-radius:10px;border:1px solid var(--border)">
      <div class="ginfo" id="onlineLobbyMsg"></div>
      <div class="ginfo" id="onlineGameCode" style="font-size:1.1em;font-weight:800;margin:8px 0"></div>
      <button class="bbtn" id="btnCopyLink" onclick="copyOnlineLink()" style="display:none">Kop√≠rovat odkaz</button>
      <button class="startBtn" id="btnEnterSecret" onclick="showOnlineSecretModal()" style="display:none;margin-top:8px">Zadat tajn√Ω k√≥d</button>
    </div>
  </div>
</div>
<div class="pg" id="pg-game">
  <div class="ghdr">
    <div class="ginfo"><span id="gameModeLabel">Pokus <span id="attNum">1</span> / <span id="attMax">10</span></span></div>
    <button class="bbtn" onclick="showTab('setup',0)">‚Üê Zpƒõt</button>
  </div>
  <div class="timer" id="timerRow" style="display:none">‚è±Ô∏è <span id="timerDisp">0:00</span></div>
  <div id="secReveal" class="secRow" style="display:none">
    <div class="rn">üîì</div><div id="secPegs" style="display:flex;gap:5px"></div><div class="secLbl">Tajn√Ω k√≥d</div>
  </div>
  <div class="board" id="board"></div>
  <div class="palSec"><div class="palLbl">Pol√≠ƒçko: Q‚ÄìR nebo ‚Üê‚Üí ¬∑ Barva: 1‚Äì8</div><div class="pal" id="palette"></div></div>
  <div class="abts">
    <button class="bSub" id="subBtn" onclick="submitGuess()" disabled>Odeslat</button>
    <button class="bClr" onclick="clearGuess()">Vymazat</button>
  </div>
</div>
<div class="pg" id="pg-stats">
  <div class="card">
    <h2>üìä Statistiky</h2>
    <div class="sTabs">
      <button class="sTab act" id="stab0" onclick="showStatTab(0)">P≈ôehled</button>
      <button class="sTab" id="stab1" onclick="showStatTab(1)">Hr√°ƒçi</button>
      <button class="sTab" id="stab2" onclick="showStatTab(2)">Porovn√°n√≠</button>
    </div>
    <div id="statView0">
      <div class="sGrid">
        <div class="sBox"><div class="val" id="stT">0</div><div class="lbl">Celkem her</div></div>
        <div class="sBox"><div class="val" id="stW">0</div><div class="lbl">V√Ωhry</div></div>
        <div class="sBox"><div class="val" id="stB">‚Äì</div><div class="lbl">Nejlep≈°√≠</div></div>
        <div class="sBox"><div class="val" id="stA">‚Äì</div><div class="lbl">Pr≈Ømƒõr pokus≈Ø</div></div>
      </div>
      <div class="sList" id="sList"><div class="noH">≈Ω√°dn√© hry zat√≠m.</div></div>
    </div>
    <div id="statView1" style="display:none">
      <select class="pSel" id="playerSel" onchange="renderPlayerStats()"><option value="">V≈°ichni hr√°ƒçi</option></select>
      <div id="playerStats"></div>
    </div>
    <div id="statView2" style="display:none">
      <div id="cmpStats"><div class="noH">≈Ω√°dn√© hry 2 hr√°ƒç≈Ø zat√≠m.</div></div>
    </div>
    <button class="clrBtn" onclick="clearStats()">Vymazat statistiky</button>
  </div>
</div>
<div class="ovl" id="endOvl">
  <div class="modal">
    <button class="mClose" onclick="hideEndModal()" title="Zav≈ô√≠t (ESC)">‚úï</button>
    <h2 id="endTitle"></h2><p id="endMsg"></p>
    <div class="btnRow"><button class="pri" id="btnAgain" onclick="playAgain()">Hr√°t znovu</button><button class="sec2" id="btnBack" onclick="goBack()">‚Üê Zpƒõt do menu</button></div>
  </div>
</div>
<div class="ovl" id="secOvl">
  <div class="modal">
    <button class="mClose" onclick="cancelSecret()" title="Zru≈°it (ESC)">‚úï</button>
    <h2 id="secTitle" style="font-size:1.15em;color:var(--acc)">Zadej tajn√Ω k√≥d</h2>
    <p id="secDesc"></p>
    <div id="secPal" style="display:flex;gap:7px;justify-content:center;flex-wrap:wrap;margin-bottom:10px"></div>
    <div id="secDisp" style="display:flex;gap:5px;justify-content:center;margin-bottom:14px"></div>
    <button class="startBtn" id="secConf" onclick="confirmSecret()" disabled>Potvrzeno ‚úì</button>
  </div>
</div>
<div class="colorPop" id="colorPop">
  <div class="cpTitle">Vyber barvu</div>
  <div class="cpColors" id="cpColors"></div>
  <button class="cpSub" id="cpSubBtn" onclick="submitFromPop()" disabled>Odeslat ‚úì</button>
</div>
<footer class="ftr" id="footer">V <span id="ver">1.4.0</span></footer>
<script>
const VERSION={major:1,minor:4,patch:0};
document.getElementById('ver').textContent=VERSION.major+'.'+VERSION.minor+'.'+VERSION.patch;
const API_BASE='api';
const C=[{h:'#e74c3c'},{h:'#3498db'},{h:'#2ecc71'},{h:'#f1c40f'},{h:'#e67e22'},{h:'#9b59b6'},{h:'#e91e8a'},{h:'#00bcd4'}];
let audioCtx=null;
let onlinePollId=null;
let onlineGame=null;
function initAudio(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();if(audioCtx.state==='suspended')audioCtx.resume().catch(()=>{})}
function playSnd(type){
  try{initAudio();
    const o=audioCtx.createOscillator();const g=audioCtx.createGain();
    o.connect(g);g.connect(audioCtx.destination);
    if(type==='peg'){o.frequency.value=440;o.type='sine';g.gain.setValueAtTime(0.15,0);g.gain.exponentialRampToValueAtTime(0.01,0.1)}
    else if(type==='submit'){o.frequency.value=330;o.type='square';g.gain.setValueAtTime(0.12,0);g.gain.exponentialRampToValueAtTime(0.01,0.15)}
    else if(type==='win'){o.frequency.value=523;o.type='sine';g.gain.setValueAtTime(0.2,0);g.gain.exponentialRampToValueAtTime(0.01,0.3)}
    else if(type==='lose'){o.frequency.value=200;o.type='sawtooth';g.gain.setValueAtTime(0.15,0);g.gain.exponentialRampToValueAtTime(0.01,0.25)}
    o.start(0);o.stop(0.3);
  }catch(e){}
}
const D={easy:{c:6,r:false,a:12},medium:{c:6,r:true,a:10},hard:{c:8,r:true,a:8}};
let G={mode:'1p',diff:'easy',n1:'',n2:'',secret:[],guess:[null,null,null,null],hist:[],over:false,maxA:10,colC:6,whoEnters:1,codeMaker:'',codeBreaker:'',startTime:0,timeLimit:0,elapsed:0};
let stats=[];
let s2p=[null,null,null,null];
let selectedSlot=null;
let timerInterval=null;
let endModalBtn=0;

const STORAGE_KEYS={stats:'logik_stats',settings:'logik_settings',theme:'logik_theme',game:'logik_game'};
function loadStats(){try{const d=localStorage.getItem(STORAGE_KEYS.stats);if(d){stats=JSON.parse(d)}}catch(e){stats=[]}}
function saveStats(){try{localStorage.setItem(STORAGE_KEYS.stats,JSON.stringify(stats))}catch(e){}}
function loadSettings(){try{const d=localStorage.getItem(STORAGE_KEYS.settings);if(d){const s=JSON.parse(d);document.getElementById('n1').value=s.n1||'';document.getElementById('n2').value=s.n2||'';G.mode=s.mode||'1p';G.diff=s.diff||'easy';G.whoEnters=s.whoEnters||1;G.timeLimit=s.timeLimit||0;setMode(G.mode);setDiff(G.diff);setWhoEnters(G.whoEnters);setTimeLimit(G.timeLimit)}}catch(e){}}
function saveSettings(){try{const s={n1:document.getElementById('n1').value.trim(),n2:document.getElementById('n2').value.trim(),mode:G.mode,diff:G.diff,whoEnters:G.whoEnters,timeLimit:G.timeLimit};localStorage.setItem(STORAGE_KEYS.settings,JSON.stringify(s))}catch(e){}}
function saveGame(){try{G.elapsed=G.startTime?Math.floor((Date.now()-G.startTime)/1000):0;const state={G:G,selectedSlot:selectedSlot};localStorage.setItem(STORAGE_KEYS.game,JSON.stringify(state))}catch(e){}}
function loadGame(){try{const curTimeLimit=G.timeLimit;const d=localStorage.getItem(STORAGE_KEYS.game);if(d){const state=JSON.parse(d);if(state.G&&state.G.secret&&state.G.secret.length>0&&!state.G.over){G=state.G;G.timeLimit=curTimeLimit;if(G.elapsed)G.startTime=Date.now()-G.elapsed*1000;selectedSlot=state.selectedSlot;return true}}return false}catch(e){return false}}
function clearGame(){try{localStorage.removeItem(STORAGE_KEYS.game)}catch(e){}}
function applyTheme(t){document.body.dataset.theme=t;document.documentElement.setAttribute('data-theme',t);document.getElementById('tglBtn').textContent=t==='dark'?'‚òÄÔ∏è':'üåô'}
function loadTheme(){try{let t=localStorage.getItem(STORAGE_KEYS.theme);if(!t&&window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches)t='dark';if(t==='dark'||t==='bright')applyTheme(t)}catch(e){}}
function saveTheme(){try{localStorage.setItem(STORAGE_KEYS.theme,document.body.dataset.theme||'bright')}catch(e){}}
if(window.matchMedia){window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change',e=>{if(!localStorage.getItem(STORAGE_KEYS.theme)){applyTheme(e.matches?'dark':'bright')}})}
loadStats();loadSettings();loadTheme();setDiff(G.diff);
(function(){
  const p=new URLSearchParams(location.search);
  if(p.get('online')==='join'&&p.get('code')){document.getElementById('onlineCode').value=p.get('code').toUpperCase().slice(0,6);showTab('online',3);document.getElementById('onlineCode').focus()}
})();
function restoreGame(){if(loadGame()){showTab('game',1);renderBoard();renderPal();document.getElementById('subBtn').disabled=G.guess.includes(null);startTimer()}}
setTimeout(restoreGame,0);

function toggleTheme(){const dk=document.body.dataset.theme==='dark';const t=dk?'bright':'dark';applyTheme(t);saveTheme()}
function showTab(t,i){if(onlinePollId){clearInterval(onlinePollId);onlinePollId=null}document.querySelectorAll('.pg').forEach(p=>p.classList.remove('act'));document.querySelectorAll('.tab').forEach(b=>b.classList.remove('act'));document.getElementById('pg-'+t).classList.add('act');document.getElementById('tab'+i).classList.add('act');if(t==='stats')renderStats();if(t==='online')showOnlineLobby()}

function setMode(m){G.mode=m;document.getElementById('m1p').classList.toggle('act',m==='1p');document.getElementById('m2p').classList.toggle('act',m==='2p');document.getElementById('n2r').style.display=m==='2p'?'flex':'none';document.getElementById('whoEntersR').style.display=m==='2p'?'flex':'none';updateDiffDesc();saveSettings()}
const DIFF_DESC={easy:'6 barev ¬∑ bez opakov√°n√≠ ¬∑ 12 pokus≈Ø',medium:'6 barev ¬∑ s opakov√°n√≠m ¬∑ 10 pokus≈Ø',hard:'8 barev ¬∑ s opakov√°n√≠m ¬∑ 8 pokus≈Ø'};
const DIFF_DESC_2P={easy:'6 barev ¬∑ 12 pokus≈Ø',medium:'6 barev ¬∑ 10 pokus≈Ø',hard:'8 barev ¬∑ 8 pokus≈Ø'};
function setDiff(d){G.diff=d;['E','M','H'].forEach(x=>document.getElementById('d'+x).classList.remove('act'));document.getElementById('d'+d[0].toUpperCase()).classList.add('act');updateDiffDesc();saveSettings()}
function updateDiffDesc(){document.getElementById('diffDesc').textContent=(G.mode==='2p'?DIFF_DESC_2P:DIFF_DESC)[G.diff]+(G.mode==='2p'?' ¬∑ opakov√°n√≠ vol√≠ zad√°vaj√≠c√≠':'')}
function setWhoEnters(w){G.whoEnters=w;document.getElementById('we1').classList.toggle('act',w===1);document.getElementById('we2').classList.toggle('act',w===2);saveSettings()}
function setTimeLimit(m){G.timeLimit=m;['Off','3','5','10'].forEach(x=>document.getElementById('tl'+x).classList.remove('act'));document.getElementById('tl'+(m===0?'Off':m)).classList.add('act');saveSettings()}

function formatTime(s){const m=Math.floor(s/60);const sec=s%60;return m+':'+(sec<10?'0':'')+sec}
function startTimer(){
  stopTimer();
  const row=document.getElementById('timerRow');
  row.style.display='block';
  updateTimerDisplay();
  timerInterval=setInterval(()=>{
    updateTimerDisplay();
    if(G.timeLimit>0){
      const elapsed=Math.floor((Date.now()-G.startTime)/1000);
      const remaining=G.timeLimit*60-elapsed;
      if(remaining<=0&&!G.over){stopTimer();timeOut()}
    }
  },1000);
}
function stopTimer(){if(timerInterval){clearInterval(timerInterval);timerInterval=null}}
function updateTimerDisplay(){
  const el=document.getElementById('timerDisp');const row=document.getElementById('timerRow');
  const elapsed=Math.floor((Date.now()-G.startTime)/1000);
  if(G.timeLimit>0){
    const remaining=Math.max(0,G.timeLimit*60-elapsed);
    el.textContent=formatTime(remaining);
    row.classList.toggle('warn',remaining<=30);
  }else{el.textContent=formatTime(elapsed);row.classList.remove('warn')}
}
function timeOut(){G.over=true;selectedSlot=null;renderBoard();revealSecret();addStat(false);clearGame();playSnd('lose');setTimeout(()=>showEnd(false,true),500)}

function genSecret(cnt,rep){const av=[];for(let i=0;i<cnt;i++)av.push(i);const code=[];const pool=[...av];for(let i=0;i<4;i++){const idx=Math.floor(Math.random()*pool.length);code.push(pool[idx]);if(!rep)pool.splice(idx,1)}return code}

function calcFB(sec,guess){let b=0,w=0;const sR=[],gR=[];for(let i=0;i<4;i++){if(sec[i]===guess[i])b++;else{sR.push(sec[i]);gR.push(guess[i])}}for(const g of gR){const idx=sR.indexOf(g);if(idx!==-1){w++;sR.splice(idx,1)}}return{b,w}}

function startGame(swap2P){
  saveSettings();stopTimer();
  G.n1=document.getElementById('n1').value.trim()||(G.mode==='1p'?'Hr√°ƒç':'Hr√°ƒç 1');
  G.n2=G.mode==='2p'?(document.getElementById('n2').value.trim()||'Hr√°ƒç 2'):'Poƒç√≠taƒç';
  G.hist=[];G.over=false;G.guess=[null,null,null,null];selectedSlot=null;G.startTime=Date.now();G.elapsed=0;
  document.getElementById('secReveal').style.display='none';
  const cfg=D[G.diff];
  if(G.mode==='1p'){G.secret=genSecret(cfg.c,cfg.r);G.maxA=cfg.a;G.colC=cfg.c;showTab('game',1);renderBoard();renderPal();startTimer();saveGame()}
  else{G.colC=cfg.c;G.maxA=cfg.a;G.secret=[];
    if(swap2P&&G.codeMaker){G.whoEnters=G.whoEnters===1?2:1;setWhoEnters(G.whoEnters)}
    G.codeMaker=G.whoEnters===1?G.n1:G.n2;G.codeBreaker=G.whoEnters===1?G.n2:G.n1;
    show2P()}
}

function show2P(){
  s2p=[null,null,null,null];
  document.getElementById('secTitle').textContent=G.codeMaker+' ‚Äì zadej tajn√Ω k√≥d';
  document.getElementById('secDesc').textContent=G.codeBreaker+' bude h√°dnout. Vyber 4 kol√≠ky.';
  const el=document.getElementById('secPal');el.innerHTML='';
  for(let i=0;i<G.colC;i++){const d=document.createElement('div');d.className='peg';d.style.background=C[i].h;d.style.width='38px';d.style.height='38px';d.style.cursor='pointer';d.onclick=(()=>{const id=i;return()=>pickS(id)})();el.appendChild(d)}
  renderSecDisp();
  document.getElementById('secOvl').classList.add('show');
}
function renderSecDisp(){
  const el=document.getElementById('secDisp');el.innerHTML='';
  for(let i=0;i<4;i++){const d=document.createElement('div');if(s2p[i]!==null){d.className='peg';d.style.background=C[s2p[i]].h;d.style.width='36px';d.style.height='36px';d.onclick=(()=>{const idx=i;return()=>removeS(idx)})()}else{d.className='peg ep';d.style.width='36px';d.style.height='36px'}el.appendChild(d)}
  document.getElementById('secConf').disabled=s2p.includes(null);
}
function pickS(id){const idx=s2p.indexOf(null);if(idx===-1)return;s2p[idx]=id;playSnd('peg');renderSecDisp()}
function removeS(idx){s2p[idx]=null;const ng=s2p.filter(v=>v!==null);while(ng.length<4)ng.push(null);s2p=[...ng];renderSecDisp()}
function confirmSecret(){
  if(window._onlineSecretConfirm){confirmOnlineSecret();return}
  G.secret=[...s2p];document.getElementById('secOvl').classList.remove('show');G.n1=G.codeBreaker;G.startTime=Date.now();showTab('game',1);renderBoard();renderPal();startTimer();saveGame()
}
function cancelSecret(){document.getElementById('secOvl').classList.remove('show');showTab('setup',0)}

function selectOrSetPeg(idx,evt){
  if(G.over)return;
  if(selectedSlot===idx&&G.guess[idx]!==null){removePeg(idx);hideColorPop();return}
  selectedSlot=idx;renderBoard();renderPal();
  if(evt)showColorPop(evt)
}
function showColorPop(evt){
  const pop=document.getElementById('colorPop');
  const colors=document.getElementById('cpColors');
  colors.innerHTML='';
  for(let i=0;i<G.colC;i++){
    const d=document.createElement('div');d.className='peg';d.style.background=C[i].h;
    d.onclick=(()=>{const id=i;return(e)=>{e.stopPropagation();pickColorPop(id)}})();
    colors.appendChild(d);
  }
  // Find current row and position popup below it
  const curRow=document.querySelector('.grow.cur');
  const rect=curRow?curRow.getBoundingClientRect():evt.target.getBoundingClientRect();
  const popW=Math.min(G.colC*52+24,300);
  let left=rect.left+(rect.width-popW)/2;
  let top=rect.bottom+6;
  if(left<8)left=8;
  if(left+popW>window.innerWidth-8)left=window.innerWidth-popW-8;
  if(top+180>window.innerHeight){top=rect.top-180}
  pop.style.left=left+'px';pop.style.top=top+'px';pop.style.width=popW+'px';
  document.getElementById('cpSubBtn').disabled=G.guess.includes(null);
  pop.classList.add('show');
}
function hideColorPop(){document.getElementById('colorPop').classList.remove('show')}
function pickColorPop(id){
  if(G.over||selectedSlot===null)return;
  G.guess[selectedSlot]=id;playSnd('peg');
  const allFilled=!G.guess.includes(null);
  document.getElementById('subBtn').disabled=!allFilled;
  document.getElementById('cpSubBtn').disabled=!allFilled;
  selectedSlot=selectedSlot<3?selectedSlot+1:null;
  renderBoard();renderPal();saveGame();
  if(selectedSlot===null&&!allFilled){hideColorPop()}
}
function submitFromPop(){
  if(G.guess.includes(null))return;
  hideColorPop();
  submitGuess();
}
function renderBoard(){
  const el=document.getElementById('board');el.innerHTML='';
  document.getElementById('attNum').textContent=G.hist.length+1;
  document.getElementById('attMax').textContent=G.maxA;
  for(let i=0;i<G.hist.length;i++){
    const h=G.hist[i];const row=document.createElement('div');row.className='grow done';
    let html='<div class="rn">'+(i+1)+'</div>';
    for(let j=0;j<4;j++)html+='<div class="peg" style="background:'+C[h.guess[j]].h+'"></div>';
    row.innerHTML=html;
    const fb=document.createElement('div');fb.className='fb';
    for(let k=0;k<h.fb.b;k++){const p=document.createElement('div');p.className='fbp fbb';fb.appendChild(p)}
    for(let k=0;k<h.fb.w;k++){const p=document.createElement('div');p.className='fbp fbw';fb.appendChild(p)}
    for(let k=0;k<4-h.fb.b-h.fb.w;k++){const p=document.createElement('div');p.className='fbp';p.style.background='transparent';fb.appendChild(p)}
    row.appendChild(fb);el.appendChild(row);
  }
  if(!G.over&&G.hist.length<G.maxA){
    const row=document.createElement('div');row.className='grow cur';
    let html='<div class="rn">'+(G.hist.length+1)+'</div>';
    row.innerHTML=html;
    for(let j=0;j<4;j++){
      const p=document.createElement('div');
      if(G.guess[j]!==null){p.className='peg'+(selectedSlot===j?' slotSel':'');p.style.background=C[G.guess[j]].h;p.onclick=(()=>{const idx=j;return(e)=>selectOrSetPeg(idx,e)})()}
      else{p.className='peg ep'+(selectedSlot===j?' slotSel':'');p.onclick=(()=>{const idx=j;return(e)=>selectOrSetPeg(idx,e)})()}
      row.appendChild(p);
    }
    el.appendChild(row);
  }
  for(let i=G.hist.length+(G.over?0:1);i<G.maxA;i++){
    const row=document.createElement('div');row.className='grow empty';
    let html='<div class="rn">'+(i+1)+'</div>';
    row.innerHTML=html;
    for(let j=0;j<4;j++){const p=document.createElement('div');p.className='peg ep';row.appendChild(p)}
    el.appendChild(row);
  }
}

function renderPal(){
  const el=document.getElementById('palette');el.innerHTML='';
  for(let i=0;i<G.colC;i++){
    const d=document.createElement('div');d.className='peg';d.style.background=C[i].h;
    d.onclick=(()=>{const id=i;return()=>pickColor(id)})();
    el.appendChild(d);
  }
}
function pickColor(id){if(G.over)return;if(selectedSlot===null)return;G.guess[selectedSlot]=id;playSnd('peg');document.getElementById('subBtn').disabled=G.guess.includes(null);hideColorPop();selectedSlot=selectedSlot<3?selectedSlot+1:null;renderBoard();renderPal();saveGame()}
function removePeg(idx){if(G.over)return;G.guess[idx]=null;selectedSlot=null;document.getElementById('subBtn').disabled=G.guess.includes(null);renderBoard();renderPal();saveGame()}
function clearGuess(){G.guess=[null,null,null,null];selectedSlot=null;hideColorPop();document.getElementById('subBtn').disabled=true;renderBoard();renderPal();saveGame()}

function submitGuess(){
  if(G.over||G.guess.includes(null))return;
  if(G.mode==='online'&&onlineGame){submitOnlineGuess();return}
  const fb=calcFB(G.secret,G.guess);
  G.hist.push({guess:[...G.guess],fb});
  G.guess=[null,null,null,null];
  document.getElementById('subBtn').disabled=true;
  playSnd('submit');
  if(fb.b===4){G.over=true;selectedSlot=null;stopTimer();renderBoard();revealSecret();addStat(true);clearGame();setTimeout(()=>showEnd(true),500)}
  else if(G.hist.length>=G.maxA){G.over=true;selectedSlot=null;stopTimer();renderBoard();revealSecret();addStat(false);clearGame();setTimeout(()=>showEnd(false),500)}
  else{selectedSlot=0;renderBoard();renderPal();saveGame()}
}

function revealSecret(){
  const el=document.getElementById('secReveal');el.style.display='flex';
  const p=document.getElementById('secPegs');p.innerHTML='';
  G.secret.forEach(id=>{const d=document.createElement('div');d.className='peg';d.style.background=C[id].h;d.style.width='34px';d.style.height='34px';p.appendChild(d)});
}

function showEnd(won,timeout){
  const t=document.getElementById('endTitle');const m=document.getElementById('endMsg');
  const guesser=G.mode==='2p'?G.codeBreaker:G.n1;
  const elapsed=Math.floor((Date.now()-G.startTime)/1000);
  const timeStr=' ('+formatTime(elapsed)+')';
  if(won){t.className='win';t.textContent='üéâ V√Ωhra!';m.textContent=guesser+' uhodl k√≥d za '+G.hist.length+' pokus'+(G.hist.length===1?'':'≈Ø')+timeStr+'!';playSnd('win')}
  else{t.className='lose';t.textContent='üòû Prohra';m.textContent=timeout?'Vypr≈°el ƒças!':'Tajn√Ω k√≥d nebyl uhoden za '+G.maxA+' pokus≈Ø.';if(!timeout)m.textContent+=timeStr;playSnd('lose')}
  endModalBtn=0;updateEndModalBtns();
  document.getElementById('endOvl').classList.add('show');
}
function hideEndModal(){document.getElementById('endOvl').classList.remove('show')}
function updateEndModalBtns(){document.getElementById('btnAgain').classList.toggle('sel',endModalBtn===0);document.getElementById('btnBack').classList.toggle('sel',endModalBtn===1)}
function playAgain(){document.getElementById('endOvl').classList.remove('show');stopTimer();clearGame();startGame(G.mode==='2p')}
function goBack(){document.getElementById('endOvl').classList.remove('show');stopTimer();clearGame();showTab('setup',0)}

function addStat(won){
  const elapsed=G.startTime?Math.floor((Date.now()-G.startTime)/1000):0;
  const stat={name:G.n1,won,att:G.hist.length,time:elapsed,diff:G.diff,mode:G.mode,date:new Date().toLocaleDateString('cs-CZ')};
  if(G.mode==='2p'){stat.opponent=G.codeMaker;stat.breaker=G.codeBreaker;stat.maker=G.codeMaker}
  stats.push(stat);saveStats();
  if(typeof API_BASE!=='undefined'&&API_BASE){
    const mode=onlineGame?'online':G.mode;
    fetch(API_BASE+'/save_result.php',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({
      player_name:G.mode==='2p'?G.codeBreaker:G.n1,won,attempts:G.hist.length,mode,difficulty:G.diff,game_code:onlineGame?onlineGame.game_code:null
    })}).then(r=>r.json()).catch(()=>{});
  }
}

let statTab=0;
function showStatTab(t){statTab=t;[0,1,2].forEach(i=>{document.getElementById('stab'+i).classList.toggle('act',i===t);document.getElementById('statView'+i).style.display=i===t?'block':'none'});if(t===1)renderPlayerStats();if(t===2)renderComparisonStats()}

function renderStats(){
  const playerName=document.getElementById('n1').value.trim()||'Hr√°ƒç';
  if(typeof API_BASE!=='undefined'&&API_BASE){
    fetch(API_BASE+'/get_stats.php?player_name='+encodeURIComponent(playerName)).then(r=>r.json()).then(data=>{
      if(data.ok&&data.stats){mergeStatsFromApi(data.stats);renderStatsUI();return}
      renderStatsUI();
    }).catch(()=>renderStatsUI());
  }else{renderStatsUI()}
}
function mergeStatsFromApi(apiStats){if(apiStats.items){stats=apiStats.items.map(s=>({name:s.player_name,won:!!parseInt(s.won,10),att:parseInt(s.attempts,10),diff:s.difficulty||'',mode:s.mode||'1p',date:s.created_at?new Date(s.created_at).toLocaleDateString('cs-CZ'):''}));saveStats()}}
function renderStatsUI(){
  const wins=stats.filter(s=>s.won);
  document.getElementById('stT').textContent=stats.length;
  document.getElementById('stW').textContent=wins.length;
  document.getElementById('stB').textContent=wins.length?Math.min(...wins.map(s=>s.att)):'‚Äì';
  document.getElementById('stA').textContent=wins.length?(Math.round(wins.reduce((a,s)=>a+s.att,0)/wins.length*10)/10):'‚Äì';
  const el=document.getElementById('sList');el.innerHTML='';
  if(!stats.length){el.innerHTML='<div class="noH">≈Ω√°dn√© hry zat√≠m.</div>';return}
  [...stats].reverse().forEach(s=>{
    const d=document.createElement('div');d.className='sItem';
    const timeStr=s.time?formatTime(s.time):'‚Äì';
    d.innerHTML='<span class="sn">'+s.name+'</span><span class="sres '+(s.won?'win':'lose')+'">'+(s.won?'V√Ωhra':'Prohra')+'</span><span class="sa">'+s.att+' pok. ¬∑ '+timeStr+' ¬∑ '+(s.diff||'')+' ¬∑ '+s.date+'</span>';
    el.appendChild(d);
  });
  if(document.getElementById('playerSel')){populatePlayerSel()}
  if(statTab===1)renderPlayerStats();
  if(statTab===2)renderComparisonStats();
}

function getPlayers(){const names=new Set();stats.forEach(s=>{names.add(s.name);if(s.opponent)names.add(s.opponent)});return[...names].sort()}
function populatePlayerSel(){const sel=document.getElementById('playerSel');if(!sel)return;const cur=sel.value;sel.innerHTML='<option value="">V≈°ichni hr√°ƒçi</option>';getPlayers().forEach(p=>{const o=document.createElement('option');o.value=p;o.textContent=p;sel.appendChild(o)});sel.value=cur}

function renderPlayerStats(){
  const el=document.getElementById('playerStats');if(!el)return;el.innerHTML='';
  const selPlayer=document.getElementById('playerSel');const selVal=selPlayer?selPlayer.value:'';
  const players=selVal?[selVal]:getPlayers();
  if(!players.length){el.innerHTML='<div class="noH">≈Ω√°dn√≠ hr√°ƒçi zat√≠m.</div>';return}
  players.forEach(p=>{
    const pGames=stats.filter(s=>s.name===p);
    const pWins=pGames.filter(s=>s.won);
    const winRate=pGames.length?Math.round(pWins.length/pGames.length*100):0;
    const bestAtt=pWins.length?Math.min(...pWins.map(s=>s.att)):'‚Äì';
    const avgAtt=pWins.length?Math.round(pWins.reduce((a,s)=>a+s.att,0)/pWins.length*10)/10:'‚Äì';
    const avgTime=pWins.length?formatTime(Math.round(pWins.reduce((a,s)=>a+(s.time||0),0)/pWins.length)):'‚Äì';
    const d=document.createElement('div');d.className='pCard';
    d.innerHTML='<div class="pName">üë§ '+p+'</div><div class="pStats"><span>Her: <span class="pVal">'+pGames.length+'</span></span><span>V√Ωhry: <span class="pVal">'+pWins.length+' ('+winRate+'%)</span></span><span>Nejlep≈°√≠: <span class="pVal">'+bestAtt+'</span></span><span>√ò pokusy: <span class="pVal">'+avgAtt+'</span></span><span>√ò ƒças: <span class="pVal">'+avgTime+'</span></span><span></span></div>';
    el.appendChild(d);
  });
}

function renderComparisonStats(){
  const el=document.getElementById('cmpStats');el.innerHTML='';
  const games2p=stats.filter(s=>s.mode==='2p'&&s.breaker&&s.maker);
  if(!games2p.length){el.innerHTML='<div class="noH">≈Ω√°dn√© hry 2 hr√°ƒç≈Ø zat√≠m.</div>';return}
  const pairs={};
  games2p.forEach(s=>{
    const key=[s.breaker,s.maker].sort().join(' vs ');
    if(!pairs[key])pairs[key]={p1:s.breaker<s.maker?s.breaker:s.maker,p2:s.breaker<s.maker?s.maker:s.breaker,games:[],w1:0,w2:0};
    pairs[key].games.push(s);
    if(s.won){if(s.breaker===pairs[key].p1)pairs[key].w1++;else pairs[key].w2++}
  });
  Object.values(pairs).forEach(pair=>{
    const total=pair.w1+pair.w2;
    const pct1=total?Math.round(pair.w1/total*100):50;
    const pct2=100-pct1;
    const d=document.createElement('div');d.className='cmpBox';
    d.innerHTML='<div class="cmpTitle">'+pair.p1+' vs '+pair.p2+'</div><div class="cmpRow"><span class="cmpN">'+pair.p1+'</span><span class="cmpV">'+pair.w1+'</span><div class="cmpBar"><div class="cmpL" style="width:'+pct1+'%"></div><div class="cmpR" style="width:'+pct2+'%"></div></div><span class="cmpV">'+pair.w2+'</span><span class="cmpN" style="text-align:right">'+pair.p2+'</span></div><div style="text-align:center;font-size:.7em;color:var(--text2);margin-top:4px">Celkem her: '+pair.games.length+'</div>';
    el.appendChild(d);
  });
}

function clearStats(){stats=[];saveStats();renderStats()}

function createOnlineGame(){
  const name=document.getElementById('n1').value.trim()||'Hr√°ƒç 1';
  fetch(API_BASE+'/create_game.php',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({player1_name:name})})
    .then(r=>r.json()).then(data=>{
      if(!data.ok){alert(data.error||'Chyba');return}
      onlineGame={game_code:data.game_code,role:'maker',player1_name:data.player1_name,player2_name:null,status:'waiting'};
      showTab('online',3);
      showOnlineLobby();
    }).catch(()=>alert('Nelze p≈ôipojit k serveru. Zkontroluj API.'));
}
function joinOnlineGame(){
  const code=document.getElementById('onlineCode').value.trim().toUpperCase();
  const name=document.getElementById('n1').value.trim()||'Hr√°ƒç 2';
  if(!code||code.length!==6){alert('Zadej 6m√≠stn√Ω k√≥d hry.');return}
  fetch(API_BASE+'/join_game.php',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({game_code:code,player2_name:name})})
    .then(r=>r.json()).then(data=>{
      if(!data.ok){alert(data.error||'Chyba');return}
      onlineGame={game_code:data.game_code,role:'breaker',player1_name:data.player1_name,player2_name:data.player2_name,status:data.status};
      showTab('online',3);
      showOnlineLobby();
      if(data.status==='secret_entered'||data.status==='playing')startOnlineGame();
      else onlinePollId=setInterval(pollOnlineGame,2000);
    }).catch(()=>alert('Nelze p≈ôipojit k serveru.'));
}
function showOnlineLobby(){
  if(!onlineGame){document.getElementById('onlineLobby').style.display='none';return}
  document.getElementById('onlineLobby').style.display='block';
  document.getElementById('onlineGameCode').textContent=onlineGame.game_code;
  document.getElementById('btnCopyLink').style.display=onlineGame.role==='maker'?'block':'none';
  if(onlineGame.role==='maker'){
    if(onlineGame.status==='waiting'){document.getElementById('onlineLobbyMsg').textContent='Sd√≠lej k√≥d nebo odkaz druh√©mu hr√°ƒçi. Pak zadej tajn√Ω k√≥d.';document.getElementById('btnEnterSecret').style.display='block'}
    else{document.getElementById('onlineLobbyMsg').textContent='Tajn√Ω k√≥d je zad√°n. ƒåek√° se na druh√©ho hr√°ƒçe nebo u≈æ h√°d√°.';document.getElementById('btnEnterSecret').style.display='none'}
  }else{document.getElementById('onlineLobbyMsg').textContent='ƒåek√° se na zad√°n√≠ k√≥du od vytvo≈ôitele.';document.getElementById('btnEnterSecret').style.display='none'}
}
function copyOnlineLink(){
  const url=location.origin+location.pathname+'?online=join&code='+onlineGame.game_code;
  navigator.clipboard.writeText(url).then(()=>alert('Odkaz zkop√≠rov√°n do schr√°nky.')).catch(()=>prompt('Zkop√≠ruj odkaz:',url));
}
function showOnlineSecretModal(){
  G.colC=6;
  s2p=[null,null,null,null];
  document.getElementById('secTitle').textContent='Zadej tajn√Ω k√≥d (online)';
  document.getElementById('secDesc').textContent='Druh√Ω hr√°ƒç bude h√°dat. Vyber 4 kol√≠ky.';
  const el=document.getElementById('secPal');el.innerHTML='';
  for(let i=0;i<6;i++){const d=document.createElement('div');d.className='peg';d.style.background=C[i].h;d.style.width='38px';d.style.height='38px';d.onclick=(()=>{const id=i;return()=>pickS(id)})();el.appendChild(d)}
  renderSecDisp();
  document.getElementById('secOvl').classList.add('show');
  window._onlineSecretConfirm=true;
}
function confirmOnlineSecret(){
  if(!window._onlineSecretConfirm){confirmSecret();return}
  window._onlineSecretConfirm=false;
  document.getElementById('secOvl').classList.remove('show');
  fetch(API_BASE+'/set_secret.php',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({game_code:onlineGame.game_code,secret:s2p})})
    .then(r=>r.json()).then(data=>{if(data.ok){onlineGame.status='secret_entered';showOnlineLobby();onlinePollId=setInterval(pollOnlineGame,2000)}}).catch(()=>{});
}
function pollOnlineGame(){
  if(!onlineGame)return
  fetch(API_BASE+'/get_game.php?game_code='+encodeURIComponent(onlineGame.game_code)).then(r=>r.json()).then(data=>{
    if(!data.ok)return
    onlineGame.status=data.status;
    if(data.status==='won'||data.status==='lost'){if(onlinePollId){clearInterval(onlinePollId);onlinePollId=null}G.hist=data.history||[];G.maxA=data.max_attempts||10;G.over=true;G.n1=data.player2_name;if(data.secret)G.secret=data.secret;revealSecret();const won=data.status==='won';addStat(won);setTimeout(()=>{showEnd(won);onlineGame=null},500);return}
    if(data.status==='secret_entered'&&onlineGame.role==='breaker'){startOnlineGame();return}
    if(data.status==='secret_entered'||data.status==='playing'){G.hist=data.history||[];G.maxA=data.max_attempts||10;G.over=false;if(onlineGame.role==='breaker')showTab('game',1);renderBoard();renderPal()}
    showOnlineLobby();
  }).catch(()=>{});
}
function startOnlineGame(){
  if(onlinePollId){clearInterval(onlinePollId);onlinePollId=null}
  fetch(API_BASE+'/get_game.php?game_code='+encodeURIComponent(onlineGame.game_code)).then(r=>r.json()).then(data=>{
    if(!data.ok)return
    G.mode='online';
    G.hist=data.history||[];
    G.maxA=data.max_attempts||10;
    G.over=data.status==='won'||data.status==='lost';
    G.secret=[];G.guess=[null,null,null,null];selectedSlot=null;
    G.n1=data.player2_name;G.codeBreaker=data.player2_name;G.codeMaker=data.player1_name;
    document.getElementById('secReveal').style.display='none';
    showTab('game',1);
    renderBoard();
    renderPal();
    if(!G.over)onlinePollId=setInterval(pollOnlineGame,2000);
  });
}
function submitOnlineGuess(){
  if(!onlineGame||G.guess.includes(null))return
  fetch(API_BASE+'/submit_guess.php',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({game_code:onlineGame.game_code,guess:G.guess})})
    .then(r=>r.json()).then(data=>{
      if(!data.ok){alert(data.error||'Chyba');return}
      G.hist=data.history||[];
      G.guess=[null,null,null,null];selectedSlot=null;
      document.getElementById('subBtn').disabled=true;
      playSnd('submit');
      if(data.won){G.over=true;if(data.secret)G.secret=data.secret;revealSecret();addStat(true);setTimeout(()=>{showEnd(true);onlineGame=null},500)}
      else if(data.lost){G.over=true;if(data.secret)G.secret=data.secret;revealSecret();addStat(false);setTimeout(()=>{showEnd(false);onlineGame=null},500)}
      else{renderBoard();renderPal()}
    }).catch(()=>alert('Chyba odesl√°n√≠.'));
}

document.addEventListener('keydown',function(e){
  if(document.activeElement&&['INPUT','TEXTAREA'].includes(document.activeElement.tagName))return;
  const endActive=document.getElementById('endOvl').classList.contains('show');
  const gameActive=document.getElementById('pg-game').classList.contains('act')&&!endActive;
  const secActive=document.getElementById('secOvl').classList.contains('show');
  if(endActive){
    const k=e.key;
    if(k==='Escape'){hideEndModal();e.preventDefault();return}
    if(k==='ArrowUp'||k==='ArrowDown'||k==='ArrowLeft'||k==='ArrowRight'){endModalBtn=endModalBtn===0?1:0;updateEndModalBtns();e.preventDefault();return}
    if(k==='Enter'){if(endModalBtn===0)playAgain();else goBack();e.preventDefault();return}
    return;
  }
  if(secActive){
    const k=e.key;
    if(k==='Escape'){cancelSecret();e.preventDefault();return}
    if(k>='1'&&k<='8'){const id=parseInt(k)-1;if(id<G.colC){pickS(id);e.preventDefault()}}
    else if(k==='Backspace'){let last=-1;for(let i=3;i>=0;i--)if(s2p[i]!==null){last=i;break}if(last>=0){removeS(last);e.preventDefault()}}
    else if(k==='Enter'&&!s2p.includes(null)){confirmSecret();e.preventDefault()}
    return;
  }
  if(!gameActive)return;
  if(G.over){if(e.key==='Escape'){e.preventDefault()}return}
  const k=e.key.toLowerCase();
  if(k==='arrowleft'){selectedSlot=selectedSlot===null?3:Math.max(0,selectedSlot-1);renderBoard();renderPal();e.preventDefault();return}
  if(k==='arrowright'){selectedSlot=selectedSlot===null?0:Math.min(3,selectedSlot+1);renderBoard();renderPal();e.preventDefault();return}
  if(k==='q'||k==='w'||k==='e'||k==='r'){const idx={'q':0,'w':1,'e':2,'r':3}[k];selectOrSetPeg(idx);e.preventDefault();return}
  if(k>='1'&&k<='8'&&selectedSlot!==null){const id=parseInt(k)-1;if(id<G.colC){pickColor(id);e.preventDefault()};return}
  if(k==='enter'){submitGuess();e.preventDefault();return}
  if(k==='backspace'){if(selectedSlot!==null&&G.guess[selectedSlot]!==null)removePeg(selectedSlot);else clearGuess();e.preventDefault();return}
  if(k==='escape'){selectedSlot=null;hideColorPop();renderBoard();renderPal();e.preventDefault()}
});
document.addEventListener('click',function(e){
  const pop=document.getElementById('colorPop');
  if(pop.classList.contains('show')&&!pop.contains(e.target)&&!e.target.classList.contains('peg')){hideColorPop();selectedSlot=null;renderBoard();renderPal()}
});
</script>
</body>
</html>